<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Å—Ç–æ–π P2P‚Äë–∑–≤–æ–Ω–æ–∫ ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è (–®–∞–≥ 1)</title>
  <style>
    :root{--bg:#0b0f14;--fg:#e8f0fe;--muted:#8aa0b4;--card:#111826;--accent:#22c55e;--accent2:#3b82f6;--err:#ef4444;--warn:#f59e0b}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans',sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:6px 0 16px}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1 1 220px}
    button{appearance:none;border:0;background:var(--accent2);color:#fff;padding:14px 16px;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(59,130,246,.35)}
    button.primary{background:var(--accent)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#152030;border:1px solid #22324a;font-size:12px;color:#b6c7da}
    textarea,input[type=text]{width:100%;background:#0b1220;color:var(--fg);border:1px solid #253041;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    audio{width:100%;margin-top:8px}
    .hidden{display:none}
    .ok{color:#22c55e}.warn{color:var(--warn)}.err{color:var(--err)}
    .big{font-size:18px}
    .center{text-align:center}
    .banner{padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0f172a;margin-bottom:12px}
    .banner.err{border-color:#7f1d1d;background:#1b0b0b}
    .banner.warn{border-color:#78350f;background:#221306}
    .kvs{display:grid;grid-template-columns:180px 1fr;gap:6px 10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #logList{max-height:220px;overflow:auto;background:#0b1220;border:1px solid #253041;border-radius:12px;padding:8px}
    #logList .it{font-size:12px;border-bottom:1px dashed #263445;padding:4px 0}
    .sep{height:1px;background:#22324a;margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üîä P2P‚Äë–∑–≤–æ–Ω–æ–∫ (WebRTC) ‚Äî –®–∞–≥ 1: –∫–∞—Ä–∫–∞—Å + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>

  <!-- –ë–∞–Ω–Ω–µ—Ä –æ —Å—Ä–µ–¥–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è / in-app –±—Ä–∞—É–∑–µ—Ä–∞—Ö -->
  <div id="envBanner" class="banner warn hidden"></div>

  <!-- –°—Ç–∞—Ç—É—Å –∏ –∞—É–¥–∏–æ -->
  <div class="card">
    <div class="row">
      <div><span class="pill">–°—Ç–∞—Ç—É—Å: <span id="status">init</span></span></div>
      <div class="muted" id="note">–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ‚Ä¶</div>
    </div>
    <audio id="remoteAudio" controls autoplay playsinline></audio>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–ø–æ–∫–∞ –±–µ–∑ –ª–æ–≥–∏–∫–∏ –∑–≤–æ–Ω–∫–∞) -->
  <div id="ctaBlock" class="card center">
    <div class="row">
      <button id="btnCall" class="primary big">üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      <button id="btnAnswer" class="big">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫</button>
    </div>
    <div class="muted">–®–∞–≥ 1 ‚Äî —Ç–æ–ª—å–∫–æ UI –∏ –æ—Ç–ª–∞–¥–∫–∞. –ó–≤–æ–Ω–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ —à–∞–≥–µ 2.</div>
  </div>

  <!-- –ë–ª–æ–∫ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ WA) -->
  <div id="shareBlock" class="card">
    <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º</h3>
    <div class="row">
      <button id="btnNativeShare" class="primary">üì§ –°–∏—Å—Ç–µ–º–Ω–æ–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª</button>
      <button id="btnShareWA">üü¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</button>
      <button id="btnCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
    <label class="muted">–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
    <input id="shareLink" type="text" readonly value="(–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —à–∞–≥–µ 2)" />
    <div class="muted" id="shareHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>
  </div>

  <!-- –ë–∞–Ω–Ω–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ–∑–∂–µ) -->
  <div id="answerBanner" class="card hidden">
    <div class="row">
      <div class="muted">–û—Ç–≤–µ—Ç –Ω–∞–π–¥–µ–Ω. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫ –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      <button id="btnStartAndApply" class="primary big">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>
  </div>

  <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
  <div class="card">
    <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
    <div class="kvs">
      <div class="muted">–ü—Ä–æ—Ç–æ–∫–æ–ª</div><div id="dbgProto" class="mono">‚Äî</div>
      <div class="muted">Secure context</div><div id="dbgSecure" class="mono">‚Äî</div>
      <div class="muted">getUserMedia</div><div id="dbgGUM" class="mono">‚Äî</div>
      <div class="muted">RTCPeerConnection</div><div id="dbgPC" class="mono">‚Äî</div>
      <div class="muted">User‚ÄëAgent</div><div id="dbgUA" class="mono">‚Äî</div>
      <div class="muted">In‚ÄëApp –±—Ä–∞—É–∑–µ—Ä</div><div id="dbgInApp" class="mono">‚Äî</div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <button id="btnCopyDiag">üß∞ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
      <div class="muted">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –ø—Ä–∏—à–ª–∏—Ç–µ –Ω–∞–º –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ.</div>
    </div>
    <div id="logList" class="mono" aria-live="polite"></div>
  </div>
</div>

<script>
// ========= –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ª–æ–≤—Ü—ã –æ—à–∏–±–æ–∫ =========
window.addEventListener('unhandledrejection', e=>{
  console.error('UnhandledRejection', e.reason);
  alert('UnhandledRejection: '+(e.reason?.message||e.reason||'unknown'));
  addLog('error','unhandledrejection: '+(e.reason?.message||e.reason));
});
window.onerror=(msg,src,line,col,err)=>{
  console.error('WindowError', msg, src, line, col, err);
  alert('Error: ' + (err?.message||msg));
  addLog('error','window.onerror: '+(err?.message||msg));
};

// ========= DOM =========
const statusEl = document.getElementById('status');
const noteEl   = document.getElementById('note');
const envBanner= document.getElementById('envBanner');
const audioEl  = document.getElementById('remoteAudio');
const ctaBlock = document.getElementById('ctaBlock');
const btnCall  = document.getElementById('btnCall');
const btnAnswer= document.getElementById('btnAnswer');
const shareBlk = document.getElementById('shareBlock');
const shareLinkEl = document.getElementById('shareLink');
const btnNativeShare = document.getElementById('btnNativeShare');
const btnShareWA = document.getElementById('btnShareWA');
const btnCopy   = document.getElementById('btnCopy');
const shareHint = document.getElementById('shareHint');
const answerBanner = document.getElementById('answerBanner');
const btnStartAndApply = document.getElementById('btnStartAndApply');

const dbgProto = document.getElementById('dbgProto');
const dbgSecure= document.getElementById('dbgSecure');
const dbgGUM   = document.getElementById('dbgGUM');
const dbgPC    = document.getElementById('dbgPC');
const dbgUA    = document.getElementById('dbgUA');
const dbgInApp = document.getElementById('dbgInApp');
const logList  = document.getElementById('logList');
const btnCopyDiag = document.getElementById('btnCopyDiag');

function setStatus(s, cls=''){ statusEl.textContent=s; statusEl.className=cls; }
function addLog(level, msg){
  const el = document.createElement('div'); el.className='it';
  const now = new Date().toLocaleTimeString();
  el.textContent = `[${now}] ${level.toUpperCase()}: ${msg}`;
  logList.prepend(el);
}

// ========= –î–µ—Ç–µ–∫—Ç in‚Äëapp –±—Ä–∞—É–∑–µ—Ä–æ–≤ =========
function detectInApp(){
  const ua = navigator.userAgent || '';
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);
  const isWhatsApp = /WhatsApp/i.test(ua) || /wv\)/i.test(ua) && /WhatsApp/i.test(navigator.appVersion||'');
  const isFB = /FBAN|FBAV|FB_IAB|FBAN\//i.test(ua);
  const isIG = /Instagram/i.test(ua);
  const isTG = /Telegram/i.test(ua);
  const inApp = (isWhatsApp||isFB||isIG||isTG);
  return {ua, isIOS, isAndroid, inApp, isWhatsApp, isFB, isIG, isTG};
}

function renderEnv(){
  const secure = window.isSecureContext;
  const proto  = location.protocol;
  const hasGUM = !!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);
  const hasPC  = typeof RTCPeerConnection === 'function';
  const d = detectInApp();

  dbgProto.textContent = proto;
  dbgSecure.textContent= String(secure);
  dbgGUM.textContent   = String(hasGUM);
  dbgPC.textContent    = String(hasPC);
  dbgUA.textContent    = d.ua;
  dbgInApp.textContent = d.inApp ? `in-app (${d.isWhatsApp? 'WhatsApp ':''}${d.isIG? 'Instagram ':''}${d.isFB? 'FB ':''}${d.isTG? 'Telegram ':''})` : '–Ω–µ—Ç';

  if(!secure || !hasGUM || !hasPC || d.inApp){
    envBanner.classList.remove('hidden');
    envBanner.innerHTML = `
      <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b>
      <ul>
        ${!secure?'<li>–ù—É–∂–µ–Ω HTTPS. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ https://</li>':''}
        ${!hasGUM?'<li>–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (getUserMedia)</li>':''}
        ${!hasPC?'<li>–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC (RTCPeerConnection)</li>':''}
        ${d.inApp?'<li>–ü–æ—Ö–æ–∂–µ, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ ¬´‚Ä¶¬ª ‚Üí <b>–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</b>.</li>':''}
      </ul>`;
  }

  addLog('info', `secure=${secure} proto=${proto} gum=${hasGUM} pc=${hasPC} inApp=${d.inApp}`);
}

// ========= –ö–Ω–æ–ø–∫–∏ (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫–∏) =========
btnCall.onclick = ()=>{ setStatus('–ù–∞–∂–∞—Ç–æ: –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫','warn'); addLog('action','btnCall clicked'); noteEl.textContent='–®–∞–≥ 2 –ø–æ–¥–∫–ª—é—á–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫.'; };
btnAnswer.onclick=()=>{ setStatus('–ù–∞–∂–∞—Ç–æ: –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫','warn'); addLog('action','btnAnswer clicked'); noteEl.textContent='–®–∞–≥ 2 –ø–æ–¥–∫–ª—é—á–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫.'; };
btnNativeShare.onclick=()=>{
  addLog('action','native share pressed');
  const txt = shareLinkEl.value || '';
  if(navigator.share){ navigator.share({title:'–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –∑–≤–æ–Ω–æ–∫', text:`–í–∞–º –∑–≤–æ–Ω—è—Ç: ${txt}`, url: txt}).catch(()=>{}); }
  else { noteEl.textContent='Native Share –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'; addLog('warn','navigator.share unavailable'); }
};
btnShareWA.onclick=()=>{
  const txt = encodeURIComponent('–í–∞–º –∑–≤–æ–Ω—è—Ç: '+(shareLinkEl.value||''));
  const url = `https://wa.me/?text=${txt}`;
  addLog('action','open wa.me');
  window.open(url, '_blank');
};
btnCopy.onclick=async()=>{
  try{ await navigator.clipboard.writeText(shareLinkEl.value||''); noteEl.textContent='–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'; addLog('info','link copied'); }
  catch{ noteEl.textContent='–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é'; addLog('error','clipboard failed'); }
};
btnCopyDiag.onclick=async()=>{
  const report = [
    '=== DIAG REPORT ===',
    'url: '+location.href,
    'secure: '+window.isSecureContext,
    'protocol: '+location.protocol,
    'ua: '+navigator.userAgent,
    'getUserMedia: '+!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),
    'RTCPeerConnection: '+(typeof RTCPeerConnection),
  ].join('\n');
  try{ await navigator.clipboard.writeText(report); addLog('info','diag copied'); }
  catch{ addLog('error','diag copy failed'); alert(report); }
};

// ========= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =========
setStatus('init');
renderEnv();
addLog('info','–®–∞–≥ 1 –∫–∞—Ä–∫–∞—Å –∑–∞–≥—Ä—É–∂–µ–Ω');

</script>
</body>
</html>
