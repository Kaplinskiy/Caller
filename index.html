<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Å—Ç–æ–π P2P-–∑–≤–æ–Ω–æ–∫ ‚Äî –æ–±–º–µ–Ω —á–µ—Ä–µ–∑ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8f0fe; --muted:#8aa0b4; --card:#111826; --accent:#22c55e; --accent2:#3b82f6; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans',sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    h1{font-size:22px;margin:6px 0 16px}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1 1 220px}
    button{appearance:none;border:0;background:var(--accent2);color:white;padding:14px 16px;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(59,130,246,.35)}
    .primary{background:var(--accent)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#152030;border:1px solid #22324a;font-size:12px;color:#b6c7da}
    textarea{width:100%;min-height:84px;background:#0b1220;color:var(--fg);border:1px solid #253041;border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    audio{width:100%;margin-top:8px}
    .hidden{display:none}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
    .big{font-size:18px}
    .center{text-align:center}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üîä P2P-–∑–≤–æ–Ω–æ–∫ (WebRTC) ‚Äî –ø—Ä–æ—Å—Ç–æ</h1>
  <p class="muted">–û–±–º–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ‚Äî —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –∏–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Å—ã–ª–∫–∏. –í—Å—ë —à–∏—Ñ—Ä—É–µ—Ç—Å—è (DTLS‚ÄëSRTP). –ë–µ–∑ QR.</p>

  <div class="card">
    <div class="row">
      <div><span class="pill">–°—Ç–∞—Ç—É—Å: <span id="status">idle</span></span></div>
      <div class="muted" id="note">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ.</div>
    </div>
    <audio id="remoteAudio" controls autoplay playsinline></audio>
  </div>

  <div class="card center">
    <div class="row">
      <button id="btnCall" class="primary big">üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      <button id="btnAnswer" class="big">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫</button>
    </div>
    <div class="muted">Caller –∂–º—ë—Ç ¬´–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫¬ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É. Callee –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ—ë ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å—Å—ã–ª–∫—É.</div>
  </div>

  <div id="shareBlock" class="card hidden">
    <h2>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h2>
    <div class="row">
      <button id="btnNativeShare" class="primary">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</button>
      <button id="btnCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
    <label class="muted">–°—Å—ã–ª–∫–∞</label>
    <textarea id="shareLink" readonly></textarea>
  </div>

  <div id="answerBanner" class="card hidden">
    <div class="row">
      <div class="muted">–ü–æ–ª—É—á–µ–Ω–∞ answer‚Äë—Å—Å—ã–ª–∫–∞. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ—ë –∫ —Ç–µ–∫—É—â–µ–º—É –∑–≤–æ–Ω–∫—É.</div>
      <button id="btnApplyAnswer" class="primary">üîó –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>
  </div>

  <div id="diag" class="card">
    <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
    <div class="muted" id="diagText">–≥–æ—Ç–æ–≤–æ</div>
  </div>
</div>

<script>
const statusEl=document.getElementById('status');
const noteEl=document.getElementById('note');
const audioEl=document.getElementById('remoteAudio');
const diagEl=document.getElementById('diagText');
const btnCall=document.getElementById('btnCall');
const btnAnswer=document.getElementById('btnAnswer');
const shareBlk=document.getElementById('shareBlock');
const shareLinkEl=document.getElementById('shareLink');
const btnNativeShare=document.getElementById('btnNativeShare');
const btnCopy=document.getElementById('btnCopy');
const answerBanner=document.getElementById('answerBanner');
const btnApplyAnswer=document.getElementById('btnApplyAnswer');

function setStatus(s,cls=''){statusEl.textContent=s;statusEl.className=cls;}
function log(m){diagEl.textContent=String(m);} 

let pc=null, localStream=null, role=null; let pendingAnswer=null;
// –í–ê–ñ–ù–û: STUN‚Äë—Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –æ–±—Ö–æ–¥–∞ NAT
const iceServers=[
  { urls:'stun:stun.l.google.com:19302' },
  { urls:'stun:global.stun.twilio.com:3478' }
];

function attachRemoteAudio(pc){ pc.addEventListener('track', ev=>{ audioEl.srcObject=ev.streams[0]; }); }
async function getMic(){ return navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }, video:false }); }
function makeShareLink(obj){ const base=location.origin+location.pathname; return `${base}#${obj.type==='offer'?'o':'a'}=${encodeURIComponent(JSON.stringify(obj))}`; }
function parseHash(){ const h=location.hash.replace(/^#/,''); if(!h) return null; const m=h.match(/^([oa])=(.+)$/); if(!m) return null; try{ const obj=JSON.parse(decodeURIComponent(m[2])); if(m[1]==='o'&&obj.type==='offer') return {kind:'offer',obj}; if(m[1]==='a'&&obj.type==='answer') return {kind:'answer',obj}; }catch{} return null; }
function waitIce(pc){ return new Promise(res=>{ if(pc.iceGatheringState==='complete') return res(); const done=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange',done); res(); } }; pc.addEventListener('icegatheringstatechange',done); setTimeout(()=>{ pc.removeEventListener('icegatheringstatechange',done); res(); }, 2500); }); }

async function startCaller(){
  role='caller'; setStatus('–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶','warn');
  localStream = await getMic();
  pc = new RTCPeerConnection({ iceServers });
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  attachRemoteAudio(pc);
  const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:false });
  await pc.setLocalDescription(offer);
  await waitIce(pc); // –∂–¥—ë–º ICE, —á—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π
  const url = makeShareLink(pc.localDescription);
  showShare(url);
  setStatus('–æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É','ok');
  tryAutoApplyAnswer();
}

async function startCalleeFromHash(offerObj){
  role='callee'; setStatus('–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç‚Ä¶','warn');
  localStream = await getMic();
  pc = new RTCPeerConnection({ iceServers });
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  attachRemoteAudio(pc);
  await pc.setRemoteDescription(new RTCSessionDescription(offerObj));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await waitIce(pc); // –≤–∫–ª—é—á–∞–µ–º ICE‚Äë–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –≤ —Å—Å—ã–ª–∫—É
  const url = makeShareLink(pc.localDescription);
  showShare(url);
  setStatus('–æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É‚Äë–æ—Ç–≤–µ—Ç Caller‚Äô—É','ok');
}

async function applyAnswerFromHash(answerObj){
  if(!pc || !pc.localDescription || pc.localDescription.type!=='offer'){
    pendingAnswer = answerObj; // —Å–æ—Ö—Ä–∞–Ω–∏–º –∏ –¥–æ–∂–¥—ë–º—Å—è, –∫–æ–≥–¥–∞ Caller –Ω–∞–∂–º—ë—Ç ¬´–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫¬ª
    answerBanner.classList.remove('hidden'); setStatus('–æ–∂–∏–¥–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π offer‚Ä¶','warn');
    return;
  }
  await pc.setRemoteDescription(new RTCSessionDescription(answerObj));
  setStatus('—Å–æ–µ–¥–∏–Ω–µ–Ω–æ','ok'); log('connected');
  history.replaceState(null,'',location.pathname+location.search); // –æ—á–∏—Å—Ç–∏–º —Ö—ç—à
}

function showShare(url){
  shareBlk.classList.remove('hidden');
  shareLinkEl.value = url;
  (async()=>{ try{ await navigator.clipboard.writeText(url); noteEl.textContent='–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä'; }catch{ noteEl.textContent='–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é'; } })();
  if(navigator.share){ btnNativeShare.disabled=false; btnNativeShare.onclick=()=>navigator.share({title:'P2P call', text:'–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Å—å –∫ –∑–≤–æ–Ω–∫—É', url}).catch(()=>{}); } else { btnNativeShare.disabled=true; }
  btnCopy.onclick=async()=>{ try{ await navigator.clipboard.writeText(url); noteEl.textContent='–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'; }catch{ noteEl.textContent='–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é'; } };
}

function handleHash(){
  const parsed = parseHash();
  if(!parsed) return;
  if(parsed.kind==='offer'){
    noteEl.textContent='–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –≤—ã–∑–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫¬ª, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.';
  } else if(parsed.kind==='answer'){
    applyAnswerFromHash(parsed.obj).catch(e=>{ setStatus('–æ—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞','err'); log(e.message||e); });
  }
}

function tryAutoApplyAnswer(){
  if(pendingAnswer && pc && pc.localDescription && pc.localDescription.type==='offer'){
    const ans = pendingAnswer; pendingAnswer=null; answerBanner.classList.add('hidden');
    applyAnswerFromHash(ans).catch(e=>{ setStatus('–æ—à–∏–±–∫–∞','err'); log(e.message||e); });
  }
}

btnCall.onclick = () => startCaller().catch(e=>{ setStatus('–æ—à–∏–±–∫–∞','err'); log(e.message||e); });
btnAnswer.onclick = () => {
  const parsed = parseHash();
  if(!parsed || parsed.kind!=='offer'){ alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –æ—Ç Caller (offer)'); return; }
  startCalleeFromHash(parsed.obj).catch(e=>{ setStatus('–æ—à–∏–±–∫–∞','err'); log(e.message||e); });
};
btnApplyAnswer.onclick = () => { if(!pendingAnswer) return; tryAutoApplyAnswer(); };

window.addEventListener('hashchange', handleHash);
handleHash();
</script>
</body>
</html>
