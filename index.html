<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P –∑–≤–æ–Ω–æ–∫ (WebRTC) ‚Äî –æ—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ TURN</title>

  <!-- –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π data-URI, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ 404 –Ω–∞ favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">

  <style>
    :root{
      --bg:#0b0f14;--fg:#e8f0fe;--muted:#8aa0b4;--card:#111826;
      --accent:#22c55e;--accent2:#3b82f6;--err:#ef4444;--warn:#f59e0b
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans',sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:6px 0 16px}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;
      padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1 1 220px}
    button{appearance:none;border:0;background:var(--accent2);color:#fff;
      padding:14px 16px;border-radius:14px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 16px rgba(59,130,246,.35)}
    button.primary{background:var(--accent)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#152030;
      border:1px solid #22324a;font-size:12px;color:#b6c7da}
    textarea,input[type=text]{width:100%;background:#0b1220;color:var(--fg);
      border:1px solid #253041;border-radius:12px;padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    audio{width:100%;margin-top:8px}
    .hidden{display:none}
    .ok{color:#22c55e}.warn{color:var(--warn)}.err{color:var(--err)}
    .big{font-size:18px}
    .center{text-align:center}
    .banner{padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0f172a;margin-bottom:12px}
    .banner.err{border-color:#7f1d1d;background:#1b0b0b}
    .banner.warn{border-color:#78350f;background:#221306}
    .kvs{display:grid;grid-template-columns:180px 1fr;gap:6px 10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #logList{max-height:220px;overflow:auto;background:#0b1220;border:1px solid #253041;border-radius:12px;padding:8px}
    #logList .it{font-size:12px;border-bottom:1px dashed #263445;padding:4px 0}
    .sep{height:1px;background:#22324a;margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üîä P2P-–∑–≤–æ–Ω–æ–∫ (WebRTC) ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –æ–±–º–µ–Ω —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ + TURN only</h1>

  <!-- –ë–∞–Ω–Ω–µ—Ä –æ–∫—Ä—É–∂–µ–Ω–∏—è -->
  <div id="envBanner" class="banner warn hidden"></div>

  <!-- –°—Ç–∞—Ç—É—Å –∏ –ø–ª–µ–µ—Ä -->
  <div class="card">
    <div class="row">
      <div><span class="pill">–°—Ç–∞—Ç—É—Å: <span id="status">init</span></span></div>
      <div class="muted" id="note">–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ‚Ä¶</div>
    </div>
    <audio id="remoteAudio" controls autoplay playsinline></audio>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div id="ctaBlock" class="card center">
    <div class="row">
      <button id="btnCall" class="primary big">üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      <button id="btnAnswer" class="big">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫</button>
    </div>
    <div class="muted">–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (?room=ABCD). –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞.</div>
  </div>

  <!-- –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ -->
  <div id="incoming" class="card hidden">
    <h3>–í–∞–º –∑–≤–æ–Ω—è—Ç</h3>
    <div class="row">
      <button id="btnAccept" class="primary big">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
      <button id="btnDecline" class="big">‚úñÔ∏è –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>
    <div class="muted">–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.</div>
  </div>

  <!-- –ü–æ–¥–µ–ª–∏—Ç—å—Å—è -->
  <div id="shareBlock" class="card hidden">
    <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º</h3>
    <div class="row">
      <button id="btnNativeShare" class="primary">üì§ –°–∏—Å—Ç–µ–º–Ω–æ–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª</button>
      <button id="btnShareWA">üü¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</button>
      <button id="btnCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
    <label class="muted">–°—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
    <input id="shareLink" type="text" readonly value="(–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)" />
    <div class="muted" id="shareHint">–ü–æ—Å–ª–µ ¬´–ü–æ–∑–≤–æ–Ω–∏—Ç—å¬ª –ø–æ—è–≤–∏—Ç—Å—è —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ ?room=ABCD</div>
  </div>

  <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
  <div class="card">
    <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
    <div class="kvs">
      <div class="muted">–ü—Ä–æ—Ç–æ–∫–æ–ª</div>          <div id="dbgProto"  class="mono">‚Äî</div>
      <div class="muted">Secure context</div>    <div id="dbgSecure" class="mono">‚Äî</div>
      <div class="muted">getUserMedia</div>      <div id="dbgGUM"    class="mono">‚Äî</div>
      <div class="muted">RTCPeerConnection</div> <div id="dbgPC"     class="mono">‚Äî</div>
      <div class="muted">User-Agent</div>        <div id="dbgUA"     class="mono">‚Äî</div>
      <div class="muted">In-App –±—Ä–∞—É–∑–µ—Ä</div>    <div id="dbgInApp"  class="mono">‚Äî</div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <button id="btnCopyDiag">üß∞ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
      <div class="muted">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –ø—Ä–∏—à–ª–∏—Ç–µ –Ω–∞–º –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ.</div>
    </div>
    <div id="logList" class="mono" aria-live="polite"></div>
  </div>
</div>

<script>
(() => {
  // –ü—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  if (window.__CALL_APP_LOADED__) return;
  window.__CALL_APP_LOADED__ = true;

  // -----------------------------
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ª–æ–≤—Ü—ã –æ—à–∏–±–æ–∫
  // -----------------------------
  window.addEventListener('unhandledrejection', (e) => {
    console.error('UnhandledRejection', e.reason);
    alert('UnhandledRejection: ' + (e.reason?.message || e.reason || 'unknown'));
  });
  window.onerror = (msg, src, line, col, err) => {
    console.error('WindowError', msg, src, line, col, err);
    alert('Error: ' + (err?.message || msg));
  };

  // -----------------------------
  // DOM
  // -----------------------------
  const statusEl       = document.getElementById('status');
  const noteEl         = document.getElementById('note');
  const envBanner      = document.getElementById('envBanner');
  const audioEl        = document.getElementById('remoteAudio');

  const btnCall        = document.getElementById('btnCall');
  const btnAnswer      = document.getElementById('btnAnswer');

  const incoming       = document.getElementById('incoming');
  const btnAccept      = document.getElementById('btnAccept');
  const btnDecline     = document.getElementById('btnDecline');

  const shareBlk       = document.getElementById('shareBlock');
  const shareLinkEl    = document.getElementById('shareLink');
  const shareHint      = document.getElementById('shareHint');
  const btnNativeShare = document.getElementById('btnNativeShare');
  const btnShareWA     = document.getElementById('btnShareWA');
  const btnCopy        = document.getElementById('btnCopy');

  const dbgProto  = document.getElementById('dbgProto');
  const dbgSecure = document.getElementById('dbgSecure');
  const dbgGUM    = document.getElementById('dbgGUM');
  const dbgPC     = document.getElementById('dbgPC');
  const dbgUA     = document.getElementById('dbgUA');
  const dbgInApp  = document.getElementById('dbgInApp');

  const logList       = document.getElementById('logList');
  const btnCopyDiag   = document.getElementById('btnCopyDiag');

  function setStatus(text, cls = '') {
    statusEl.textContent = text;
    statusEl.className = cls;
  }

  function addLog(level, msg) {
    const el = document.createElement('div');
    el.className = 'it';
    const now = new Date().toLocaleTimeString();
    el.textContent = `[${now}] ${level.toUpperCase()}: ${msg}`;
    logList.prepend(el);
  }

  // -----------------------------
  // –î–µ—Ç–µ–∫—Ç In-App –±—Ä–∞—É–∑–µ—Ä–æ–≤
  // -----------------------------
  function detectInApp() {
    const ua = navigator.userAgent || '';

    const isWhatsApp =
      /WhatsApp/i.test(ua) ||
      ( /wv\)/i.test(ua) && /WhatsApp/i.test(navigator.appVersion || '') );

    const isFB = /FBAN|FBAV|FB_IAB|FBAN\//i.test(ua);
    const isIG = /Instagram/i.test(ua);
    const isTG = /Telegram/i.test(ua);

    return {
      ua,
      inApp: (isWhatsApp || isFB || isIG || isTG)
    };
  }

  function renderEnv() {
    const secure = window.isSecureContext;
    const proto  = location.protocol;
    const hasGUM = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    const hasPC  = (typeof RTCPeerConnection === 'function');
    const d      = detectInApp();

    dbgProto.textContent  = proto;
    dbgSecure.textContent = String(secure);
    dbgGUM.textContent    = String(hasGUM);
    dbgPC.textContent     = String(hasPC);
    dbgUA.textContent     = navigator.userAgent;
    dbgInApp.textContent  = d.inApp ? 'in-app' : '–Ω–µ—Ç';

    // –ü–æ–∫–∞–∂–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å—Ä–µ–¥–∞ –ø—Ä–æ–±–ª–µ–º–Ω–∞—è
    if (!secure || !hasGUM || !hasPC || d.inApp) {
      envBanner.classList.remove('hidden');
      envBanner.innerHTML = `
        <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b>
        <ul>
          ${!secure ? '<li>–ù—É–∂–µ–Ω HTTPS</li>' : ''}
          {!hasGUM ? '<li>getUserMedia –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</li>' : ''}
          ${!hasPC ? '<li>WebRTC –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</li>' : ''}
          ${d.inApp ? '<li>–û—Ç–∫—Ä—ã—Ç—å –≤–æ –≤–Ω–µ—à–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ (Share ‚Üí Open in Browser)</li>' : ''}
        </ul>
      `.replace('{!hasGUM','${'); // –º–µ–ª–∫–∏–π —Ç—Ä—é–∫, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–æ —Å–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–º —à–∞–±–ª–æ–Ω–æ–º
    }
  }

  // -----------------------------
  // –°–∏–≥–Ω–∞–ª–∏–Ω–≥ (Render WebSocket)
  // -----------------------------
  const SERVER_URL = 'https://webrtc-signal-4t7n.onrender.com';

  let ws       = null;
  let roomId   = null;
  let memberId = null;
  let role     = null; // 'caller' | 'callee'
  let pingTimer = null;

  async function apiCreateRoom(customId) {
    const res = await fetch(`${SERVER_URL}/rooms`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(customId ? { roomId: customId } : {})
    });
    if (!res.ok) throw new Error('create room failed');
    return res.json();
  }

  function wsSend(type, payload) {
    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type, roomId, from: memberId, payload }));
    }
  }

  /**
 * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket-—Å–∏–≥–Ω–∞–ª–∏–Ω–≥—É –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π.
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise, –∫–æ—Ç–æ—Ä—ã–π resolve'–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è "hello".
 *
 * @param {'caller'|'callee'} _role  –†–æ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
 * @param {string}            rid    ID –∫–æ–º–Ω–∞—Ç—ã
 */
function connectWS(_role, rid) {
  return new Promise((resolve, reject) => {
    // --- —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–Ω–∞—Ç—ã/—Ä–æ–ª–∏ ---
    role   = _role;
    roomId = rid;

    // –°—Ç—Ä–æ–∏–º ws:// –∏–ª–∏ wss:// URL –Ω–∞ –æ—Å–Ω–æ–≤–µ SERVER_URL
    const url = `${SERVER_URL.replace('http', 'ws')}/ws` +
                `?roomId=${encodeURIComponent(rid)}` +
                `&role=${encodeURIComponent(_role)}`;

    addLog('signal', `connect WS ${url}`);

    // --- –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–∫–µ—Ç ---
    ws = new WebSocket(url);

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ ping'–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    const startKeepAlive = () => {
      clearInterval(pingTimer);
      pingTimer = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          wsSend('ping', { t: Date.now() });
        }
      }, 20_000);
    };

    // ---------- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∫–µ—Ç–∞ ----------
    ws.onopen = () => {
      addLog('signal', 'ws open');
      startKeepAlive();
    };

    ws.onerror = (e) => {
      addLog('error', 'ws error');
      // –ù–µ –æ—Ç–≤–µ—Ä–≥–∞–µ–º Promise —Å—Ä–∞–∑—É ‚Äî –¥–∞–¥–∏–º —à–∞–Ω—Å onmessage('hello') –¥–æ–≥–Ω–∞—Ç—å—Å—è,
      // –Ω–æ –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è ‚Äî reject –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –≤ onclose.
    };

    ws.onclose = (e) => {
      addLog('signal', `ws close code=${e.code}`);
      clearInterval(pingTimer);
      setStatus('WS –∑–∞–∫—Ä—ã—Ç', 'warn');
      // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –¥–æ hello ‚Äî –æ—Ç–∫–ª–æ–Ω—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      if (!memberId) {
        reject(new Error('WebSocket closed before hello'));
      }
    };

    ws.onmessage = (ev) => {
      let msg;

      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–∞—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
      try {
        msg = JSON.parse(ev.data);
      } catch {
        addLog('error', 'ws bad json');
        return;
      }

      addLog('signal', `recv ${msg.type}`);

      // ---- –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π ----
      switch (msg.type) {
        // Handshake –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞
        case 'hello': {
          memberId = msg.memberId;
          setStatus(`WS ok. –ö–æ–º–Ω–∞—Ç–∞ ${roomId}`, 'ok');
          resolve(msg); // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
          break;
        }

        // –í –∫–æ–º–Ω–∞—Ç—É –≤–æ—à—ë–ª –≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫
        case 'member.joined': {
          noteEl.textContent = '–í –∫–æ–º–Ω–∞—Ç—É –≤–æ—à—ë–ª —É—á–∞—Å—Ç–Ω–∏–∫';
          // –ï—Å–ª–∏ –º—ã Caller –∏ —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ PC/–º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º offer –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
          if (role === 'caller') {
            sendOfferIfPossible();
          }
          break;
        }

        // –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É
        case 'member.left': {
          noteEl.textContent = '–£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É';
          break;
        }

        // –ü—Ä–∏—à—ë–ª —É–¥–∞–ª—ë–Ω–Ω—ã–π OFFER (–¥–ª—è callee)
        case 'offer': {
          pendingOffer = msg.payload;
          incoming.classList.remove('hidden');
          setStatus('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –ü—Ä–∏–Ω—è—Ç—å', 'warn');
          break;
        }

        // –ü—Ä–∏—à—ë–ª ANSWER (–¥–ª—è caller)
        case 'answer': {
          if (!pc) {
            addLog('error', 'answer without pc');
            return;
          }

          pc.setRemoteDescription(new RTCSessionDescription(msg.payload))
            .then(() => {
              addLog('webrtc', 'answer applied');

              // –§–ª–∞–≥ ‚Äî —É–¥–∞–ª—ë–Ω–Ω–æ–µ SDP —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
              remoteDescApplied = true;

              // –ü—Ä–æ–ª–∏–≤–∞–µ–º —Ä–∞–Ω–µ–µ –±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ICE
              pendingRemoteICE.forEach(cand =>
                pc.addIceCandidate(new RTCIceCandidate(cand))
                  .catch(e => addLog('error', 'addIce(flush): ' + e.message))
              );
              pendingRemoteICE = [];
            })
            .catch(e => {
              addLog('error', 'apply answer: ' + e.message);
              setStatus('–æ—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞', 'err');
            });
          break;
        }

        // –ü—Ä–∏—à—ë–ª —É–¥–∞–ª—ë–Ω–Ω—ã–π ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç
        case 'ice': {
          const c = msg.payload;
          if (!c || !c.candidate) return;

          // –ï—Å–ª–∏ PC –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ remote SDP –Ω–µ –ø—Ä–∏–º–µ–Ω—ë–Ω ‚Äî –±—É—Ñ–µ—Ä–∏–∑—É–µ–º
          if (!pc || !remoteDescApplied) {
            pendingRemoteICE.push(c);
            addLog('signal', 'buffer ICE (' + pendingRemoteICE.length + ')');
          } else {
            pc.addIceCandidate(new RTCIceCandidate(c))
              .then(() => addLog('webrtc', 'addIce ok'))
              .catch(e => addLog('error', 'addIce: ' + e.message));
          }
          break;
        }

        // –û—à–∏–±–∫–∞ –æ—Ç —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞
        case 'error': {
          setStatus('–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'err');
          addLog('error', msg.code || 'unknown');
          break;
        }

        // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ keep-alive
        case 'ping':
        case 'pong': {
          // no-op
          break;
        }

        // –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–ª–æ–≥–∏—Ä—É–µ–º
        default: {
          addLog('warn', 'unknown ws type: ' + msg.type);
        }
      }
    };
  });
}

  function shareRoomLink(rid) {
    const base = location.origin + location.pathname;
    const link = `${base}?room=${encodeURIComponent(rid)}`;
    shareLinkEl.value = link;
    shareBlk.classList.remove('hidden');
    shareHint.textContent = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É (–≤ WhatsApp ‚Üí ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ¬ª).';
  }

  // -----------------------------
  // WebRTC —è–¥—Ä–æ (TURN only)
  // -----------------------------
  /** –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ PC/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞/—Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞ */
  let pc = null;
  let pendingRemoteICE = [];           // –±—É—Ñ–µ—Ä –≤—Ö–æ–¥—è—â–∏—Ö ICE
  let remoteDescApplied = false;       // —Ñ–ª–∞–≥, —á—Ç–æ —É–¥–∞–ª—ë–Ω–Ω–æ–µ SDP —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏
  let localStream = null;
  let pendingOffer = null;
  let offerSent = false;
  let readyToCall = false;

  /** –¢–æ–ª—å–∫–æ TURN ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ URI –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ */
  const iceServers = [
    {
      urls: [
        // TLS (–ø–æ—Ä—Ç 5349) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ "turns:" –∏ —Ç—Ä–µ–±—É–µ—Ç transport=tcp
        "turns:turn.zababba.com:5349?transport=tcp",
        // –û–±—ã—á–Ω—ã–π TURN (–ø–æ—Ä—Ç 3478): UDP –∏ TCP
        "turn:turn.zababba.com:3478?transport=udp",
        "turn:turn.zababba.com:3478?transport=tcp"
      ],
      username: "demo",
      credential: "FaInA2019!"
    }
  ];

  function createPC() {
    pc = new RTCPeerConnection({
      iceServers,
      iceTransportPolicy: 'relay' // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ TURN
    });

    pc.onicecandidate = (ev) => {
      if (ev.candidate) wsSend('ice', ev.candidate.toJSON());
    };

    pc.oniceconnectionstatechange = () => {
      addLog('webrtc', 'ice=' + pc.iceConnectionState);
    };

    pc.onconnectionstatechange = () => {
      addLog('webrtc', 'state=' + pc.connectionState);
    };

    pc.ontrack = (ev) => {
      audioEl.srcObject = ev.streams[0];
      addLog('webrtc', 'remote track');
    };
  }

  async function getMic() {
    if (!navigator.mediaDevices?.getUserMedia) {
      throw new Error('getUserMedia –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS)');
    }
    return navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true },
      video: false
    });
  }

  async function startCaller() {
    try {
      if (!ws || ws.readyState !== 1) throw new Error('WS –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω');

      setStatus('–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶', 'warn');

      localStream = await getMic();
      createPC();
      localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));

      readyToCall = true;
      addLog('webrtc','pc ready, waiting peer to join');
      setStatus('–ö–æ–º–Ω–∞—Ç–∞ –≥–æ—Ç–æ–≤–∞. –ñ–¥—ë–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞‚Ä¶', 'ok');
    } catch (e) {
      setStatus('–æ—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞', 'err');
      addLog('error', e.message || e);
      alert('Start error: ' + (e.message || e));
    }
  }

  async function sendOfferIfPossible() {
    try {
      if (offerSent) return;
      if (!(ws && ws.readyState === 1)) return;
      if (!(pc && localStream)) return;

      const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: false });
      await pc.setLocalDescription(offer);
      addLog('webrtc','offer created');

      wsSend('offer', pc.localDescription);
      offerSent = true;

      setStatus('–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ñ—Ñ–µ—Ä ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç', 'ok');
    } catch (e) {
      addLog('error', 'sendOffer: ' + (e.message || e));
      setStatus('–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ñ—Ñ–µ—Ä–∞', 'err');
    }
  }

  async function acceptIncoming() {
    try {
      if (!pendingOffer) {
        addLog('warn','–Ω–µ—Ç –æ—Ñ—Ñ–µ—Ä–∞');
        return;
      }
      setStatus('–ø—Ä–∏–Ω–∏–º–∞–µ–º‚Ä¶', 'warn');
      incoming.classList.add('hidden');

      localStream = await getMic();
      createPC();
      localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));

      await pc.setRemoteDescription(new RTCSessionDescription(pendingOffer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      wsSend('answer', pc.localDescription);
      setStatus('–æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'ok');
    } catch (e) {
      setStatus('–æ—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞', 'err');
      addLog('error', e.message || e);
      alert('Answer error: ' + (e.message || e));
    }
  }

  // -----------------------------
  // URL ‚Üí —Ä–æ–ª—å/–∫–æ–º–Ω–∞—Ç–∞
  // -----------------------------
  function parseRoomFromUrl() {
    const u = new URL(location.href);
    return u.searchParams.get('room');
  }

  async function initByUrl() {
    const rid = parseRoomFromUrl();
    if (!rid) {
      addLog('info', '–Ω–µ—Ç room –≤ URL ‚Äî —ç—Ç–æ Caller');
      return;
    }
    await connectWS('callee', rid);
    setStatus('WS –ø–æ–¥–∫–ª—é—á—ë–Ω, –∂–¥—ë–º –æ—Ñ—Ñ–µ—Ä', 'ok');
  }

  // -----------------------------
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
  // -----------------------------
  btnCall.onclick = async () => {
    try {
      // –ï—Å–ª–∏ WS —É–∂–µ –µ—Å—Ç—å –∏ PC –≥–æ—Ç–æ–≤ ‚Äî —Å—Ä–∞–∑—É –ø–æ—Å—ã–ª–∞–µ–º –æ—Ñ—Ñ–µ—Ä
      if (ws && ws.readyState === 1 && readyToCall) {
        addLog('action', 'btnCall ‚Üí sendOfferIfPossible');
        await sendOfferIfPossible();
        return;
      }

      // –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—É –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º PC/–º–∏–∫—Ä–æ—Ñ–æ–Ω
      setStatus('–°–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—É‚Ä¶', 'warn');
      const { roomId: rid } = await apiCreateRoom();
      await connectWS('caller', rid);
      shareRoomLink(rid);
      await startCaller();

      setStatus('–ö–æ–º–Ω–∞—Ç–∞ –≥–æ—Ç–æ–≤–∞. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π –∏–ª–∏ –∂–¥–∏—Ç–µ –≤—Ö–æ–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞', 'ok');
    } catch (e) {
      setStatus('–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã', 'err');
      addLog('error', e.message || e);
    }
  };

  btnAnswer.onclick = async () => {
    const rid = parseRoomFromUrl();
    if (!rid) {
      alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å ?room=‚Ä¶');
      addLog('warn','btnAnswer –±–µ–∑ room');
      return;
    }
    await connectWS('callee', rid);
  };

  btnAccept.onclick  = () => acceptIncoming();
  btnDecline.onclick = () => { incoming.classList.add('hidden'); setStatus('–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ','warn'); };

  btnNativeShare.onclick = () => {
    const txt = shareLinkEl.value || '';
    if (navigator.share) {
      navigator.share({ title:'–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –∑–≤–æ–Ω–æ–∫', text:`–í–∞–º –∑–≤–æ–Ω—è—Ç: ${txt}`, url: txt }).catch(()=>{});
    } else {
      noteEl.textContent = 'Native Share –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    }
  };

  btnShareWA.onclick = () => {
    const txt = encodeURIComponent('–í–∞–º –∑–≤–æ–Ω—è—Ç: ' + (shareLinkEl.value || ''));
    const url = `https://wa.me/?text=${txt}`;
    window.open(url, '_blank');
  };

  btnCopy.onclick = async () => {
    try {
      await navigator.clipboard.writeText(shareLinkEl.value || '');
      noteEl.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
    } catch {
      noteEl.textContent = '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é';
    }
  };

  btnCopyDiag.onclick = async () => {
    const report = [
      '=== DIAG REPORT ===',
      'url: ' + location.href,
      'secure: ' + window.isSecureContext,
      'protocol: ' + location.protocol,
      'ua: ' + navigator.userAgent,
      'getUserMedia: ' + !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
      'RTCPeerConnection: ' + (typeof RTCPeerConnection),
      'server: ' + SERVER_URL,
      'room: ' + (roomId || parseRoomFromUrl() || '-')
    ].join('\n');

    try { await navigator.clipboard.writeText(report); }
    catch { alert(report); }
  };

  // -----------------------------
  // –°—Ç–∞—Ä—Ç
  // -----------------------------
  setStatus('init');
  renderEnv();
  addLog('info','–ö–ª–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω (TURN only, relay enforced)');
  initByUrl();
})();
</script>
</body>
</html>
