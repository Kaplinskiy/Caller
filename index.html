<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Å—Ç–æ–π P2P-–∑–≤–æ–Ω–æ–∫ ‚Äî –æ–±–º–µ–Ω —á–µ—Ä–µ–∑ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8f0fe; --muted:#8aa0b4; --card:#111826; --accent:#22c55e; --accent2:#3b82f6; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans',sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    h1{font-size:22px;margin:6px 0 16px}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1 1 220px}
    button{appearance:none;border:0;background:var(--accent2);color:white;padding:14px 16px;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(59,130,246,.35)}
    .primary{background:var(--accent)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#152030;border:1px solid #22324a;font-size:12px;color:#b6c7da}
    textarea{width:100%;min-height:84px;background:#0b1220;color:var(--fg);border:1px solid #253041;border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    audio{width:100%;margin-top:8px}
    .hidden{display:none}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
    .big{font-size:18px}
    .center{text-align:center}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üîä P2P-–∑–≤–æ–Ω–æ–∫ (WebRTC) ‚Äî –ø—Ä–æ—Å—Ç–æ</h1>
  <p class="muted">–û–±–º–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ‚Äî —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –∏–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏. –í—Å—ë —à–∏—Ñ—Ä—É–µ—Ç—Å—è (DTLS-SRTP).</p>

  <div class="card">
    <div class="row">
      <div><span class="pill">–°—Ç–∞—Ç—É—Å: <span id="status">idle</span></span></div>
      <div class="muted" id="note">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ.</div>
    </div>
    <audio id="remoteAudio" controls autoplay playsinline></audio>
  </div>

  <div class="card center">
    <div class="row">
      <button id="btnCall" class="primary big">üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      <button id="btnAnswer" class="big">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫</button>
    </div>
    <div class="muted">Caller –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫¬ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª. Callee –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ—ë ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å—Å—ã–ª–∫—É.</div>
  </div>

  <div id="shareBlock" class="card hidden">
    <h2>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h2>
    <div class="row">
      <button id="btnNativeShare" class="primary">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</button>
      <button id="btnCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
    <label class="muted">–°—Å—ã–ª–∫–∞</label>
    <textarea id="shareLink" readonly></textarea>
  </div>

  <div id="answerBanner" class="card hidden">
    <div class="row">
      <div class="muted">–ü–æ–ª—É—á–µ–Ω–∞ answer-—Å—Å—ã–ª–∫–∞. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ—ë –∫ —Ç–µ–∫—É—â–µ–º—É –∑–≤–æ–Ω–∫—É.</div>
      <button id="btnApplyAnswer" class="primary">üîó –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>
  </div>

  <div id="diag" class="card">
    <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
    <div class="muted" id="diagText">–≥–æ—Ç–æ–≤–æ</div>
  </div>
</div>

<script>
const statusEl=document.getElementById('status');
const noteEl=document.getElementById('note');
const audioEl=document.getElementById('remoteAudio');
const btnCall=document.getElementById('btnCall');
const btnAnswer=document.getElementById('btnAnswer');
const shareBlk=document.getElementById('shareBlock');
const shareLinkEl=document.getElementById('shareLink');
const btnNativeShare=document.getElementById('btnNativeShare');
const btnCopy=document.getElementById('btnCopy');
const answerBanner=document.getElementById('answerBanner');
const btnApplyAnswer=document.getElementById('btnApplyAnswer');

let pc=null,localStream=null,role=null;let pendingAnswer=null;

function makeShareLink(obj){
  const base=location.origin+location.pathname;
  return base+'#'+(obj.type==='offer'?'o':'a')+'='+encodeURIComponent(JSON.stringify(obj));
}

function showShare(url){
  shareBlk.classList.remove('hidden');
  shareLinkEl.value=url;
  navigator.clipboard.writeText(url).catch(()=>{});
  if(navigator.share){btnNativeShare.onclick=()=>navigator.share({url});}
  btnCopy.onclick=()=>navigator.clipboard.writeText(url);
}

async function startCaller(){
  role='caller';
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=ev=>{audioEl.srcObject=ev.streams[0];};
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  const url=makeShareLink(pc.localDescription);
  showShare(url);
  if(pendingAnswer) applyAnswerFromHash(pendingAnswer);
}

async function startCalleeFromHash(offerObj){
  role='callee';
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=ev=>{audioEl.srcObject=ev.streams[0];};
  await pc.setRemoteDescription(new RTCSessionDescription(offerObj));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  const url=makeShareLink(pc.localDescription);
  showShare(url);
}

async function applyAnswerFromHash(answerObj){
  if(!pc||!pc.localDescription||pc.localDescription.type!=='offer'){
    pendingAnswer=answerObj;
    answerBanner.classList.remove('hidden');
    return;
  }
  await pc.setRemoteDescription(new RTCSessionDescription(answerObj));
  statusEl.textContent='—Å–æ–µ–¥–∏–Ω–µ–Ω–æ';
  answerBanner.classList.add('hidden');
}

btnCall.onclick=()=>startCaller();
btnAnswer.onclick=()=>{
  const h=location.hash;
  if(h.startsWith('#o=')){
    try{const obj=JSON.parse(decodeURIComponent(h.substring(3)));startCalleeFromHash(obj);}catch(e){console.error(e);}
  }
};
btnApplyAnswer.onclick=()=>{if(pendingAnswer) applyAnswerFromHash(pendingAnswer)};

// –∞–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load',()=>{
  const h=location.hash;
  if(h.startsWith('#a=')){
    try{const obj=JSON.parse(decodeURIComponent(h.substring(3)));applyAnswerFromHash(obj);}catch(e){console.error(e);}
  }
});
</script>
</body>
</html>
