<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Voice Call (WebRTC ‚Ä¢ Manual Signaling)</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8f0fe; --muted:#8aa0b4; --card:#111826; --accent:#3b82f6; }
    html,body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Noto Sans", sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 880px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 22px; margin: 6px 0 16px; }
    .card { background: var(--card); border: 1px solid #1e293b; border-radius: 16px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.35); margin-bottom: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { flex:1 1 220px; }
    label { font-size: 13px; color: var(--muted); display:block; margin: 6px 0; }
    textarea, input[type="text"] { width:100%; background:#0b1220; color:var(--fg); border:1px solid #253041; border-radius:12px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    textarea { min-height: 120px; resize: vertical; }
    button { appearance:none; border:0; background:var(--accent); color:white; padding:12px 16px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow: 0 6px 16px rgba(59,130,246,.35); }
    button.ghost { background:#1f2937; box-shadow:none; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .muted { color:var(--muted); font-size: 13px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#152030; border:1px solid #22324a; font-size:12px; color:#b6c7da; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 1fr 1fr; } }
    audio { width:100%; margin-top:8px; }
    .ok { color:#22c55e; }
    .warn { color:#f59e0b; }
    .err { color:#ef4444; }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üîä P2P Voice Call ‚Äî WebRTC (manual signaling via messenger)</h1>
    <p class="muted">Two users call each other directly, exchanging short ‚Äúkeys‚Äù (SDP offer/answer) through any messenger. Audio is end‚Äëto‚Äëend encrypted (DTLS‚ÄëSRTP). No server for media. Uses STUN only.</p>

    <div class="card">
      <div class="row">
        <div><span class="pill">Status: <span id="status">idle</span></span></div>
        <div class="muted" id="note">Grant microphone permission on first action.</div>
      </div>
      <audio id="remoteAudio" controls autoplay playsinline></audio>
    </div>

    <div class="grid">
      <!-- Caller side -->
      <div class="card" id="callerCard">
        <h2>üìû Caller</h2>
        <ol class="small">
          <li>Tap <b>Start new call</b> ‚Üí copy the generated <i>Call Key</i>.</li>
          <li>Send the <i>Call Key</i> to the callee via messenger.</li>
          <li>Paste the returned <i>Answer Key</i> and press <b>Connect</b>.</li>
        </ol>
        <div class="row">
          <button id="btnStartCall">Start new call</button>
          <button class="ghost" id="btnStopCall" disabled>Hang up</button>
        </div>
        <label>Call Key (send to callee)</label>
        <textarea id="offerOut" placeholder="Will appear here after Start new call" readonly></textarea>
        <label>Answer Key (paste from callee)</label>
        <textarea id="answerIn" placeholder="Paste callee's Answer Key here"></textarea>
        <div class="row">
          <button id="btnAcceptAnswer" disabled>Connect</button>
          <button class="ghost" id="btnCopyOffer" disabled>Copy Call Key</button>
        </div>
      </div>

      <!-- Callee side -->
      <div class="card" id="calleeCard">
        <h2>‚úÖ Callee</h2>
        <ol class="small">
          <li>Paste <i>Call Key</i> from the caller.</li>
          <li>Tap <b>Generate Answer</b> ‚Üí copy the <i>Answer Key</i> and send back.</li>
        </ol>
        <label>Call Key (paste from caller)</label>
        <textarea id="offerIn" placeholder="Paste caller's Call Key here"></textarea>
        <div class="row">
          <button id="btnAcceptOffer">Generate Answer</button>
          <button class="ghost" id="btnStopAnswer" disabled>Hang up</button>
        </div>
        <label>Answer Key (send back to caller)</label>
        <textarea id="answerOut" placeholder="Will appear here after Generate Answer" readonly></textarea>
        <div class="row">
          <button class="ghost" id="btnCopyAnswer" disabled>Copy Answer Key</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>‚ÑπÔ∏è Notes</h2>
      <ul class="small">
        <li>Works best when at least one side is not behind strict CG‚ÄëNAT. If both are, you may need TURN (relay). This demo doesn‚Äôt use TURN by default.</li>
        <li>The ‚Äúkeys‚Äù include ICE candidates. We wait for ICE gathering complete to keep them single‚Äëshot (no trickle).</li>
        <li>Audio only. Mobile browsers require a user gesture before audio can play.</li>
      </ul>
    </div>
  </div>

<script>
// ---- Utilities: base64url encode/decode short JSON payloads ----
function b64uEncode(obj){
  const s = JSON.stringify(obj);
  const b = btoa(unescape(encodeURIComponent(s)));
  return b.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64uDecode(str){
  const b = (str + '===').slice(0, Math.ceil((str.length)/4)*4).replace(/-/g,'+').replace(/_/g,'/');
  const s = decodeURIComponent(escape(atob(b)));
  return JSON.parse(s);
}

// ---- Elements ----
const statusEl = document.getElementById('status');
const noteEl = document.getElementById('note');
const audioEl = document.getElementById('remoteAudio');

const btnStartCall = document.getElementById('btnStartCall');
const btnStopCall  = document.getElementById('btnStopCall');
const offerOut = document.getElementById('offerOut');
const answerIn = document.getElementById('answerIn');
const btnAcceptAnswer = document.getElementById('btnAcceptAnswer');
const btnCopyOffer = document.getElementById('btnCopyOffer');

const offerIn = document.getElementById('offerIn');
const btnAcceptOffer = document.getElementById('btnAcceptOffer');
const btnStopAnswer = document.getElementById('btnStopAnswer');
const answerOut = document.getElementById('answerOut');
const btnCopyAnswer = document.getElementById('btnCopyAnswer');

// ---- WebRTC state ----
let pcCaller = null;
let pcCallee = null;
let localStreamCaller = null;
let localStreamCallee = null;

const iceServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:global.stun.twilio.com:3478' }
];

function setStatus(s, cls=''){ statusEl.textContent = s; statusEl.className = cls; }

function waitIceGathering(pc){
  return new Promise(resolve => {
    if (pc.iceGatheringState === 'complete') return resolve();
    function check(){ if (pc.iceGatheringState === 'complete'){ pc.removeEventListener('icegatheringstatechange', check); resolve(); } }
    pc.addEventListener('icegatheringstatechange', check);
    // Safety timeout: resolve after 3s even if not complete
    setTimeout(()=>{ pc.removeEventListener('icegatheringstatechange', check); resolve(); }, 3000);
  });
}

function attachRemoteAudio(pc){
  pc.addEventListener('track', ev => {
    const [remoteStream] = ev.streams;
    audioEl.srcObject = remoteStream;
  });
}

async function getMic(){
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    throw new Error('getUserMedia unavailable (insecure context or old browser)');
  }
  return navigator.mediaDevices.getUserMedia({
    audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
    video:false
  });
}

// ---- Caller flow ----
btnStartCall.onclick = async () => {
  try{
    setStatus('preparing (caller)‚Ä¶', 'warn');
    localStreamCaller = await getMic();
    pcCaller = new RTCPeerConnection({ iceServers });
    localStreamCaller.getTracks().forEach(t => pcCaller.addTrack(t, localStreamCaller));
    attachRemoteAudio(pcCaller);

    const offer = await pcCaller.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: false });
    await pcCaller.setLocalDescription(offer);
    await waitIceGathering(pcCaller);

    const payload = { sdp: pcCaller.localDescription.sdp, type: pcCaller.localDescription.type };
    const key = b64uEncode(payload);
    offerOut.value = key;
    btnCopyOffer.disabled = false;
    btnAcceptAnswer.disabled = false;
    btnStopCall.disabled = false;
    setStatus('call key ready ‚Äî send to callee', 'ok');
 } catch (e) {
  console.error(e);
  const msg = (e && (e.name || e.message)) ? `${e.name || ''}: ${e.message || ''}` : 'unknown error';
  setStatus('error starting call', 'err');
  noteEl.textContent = 'Start error ‚Üí ' + msg +
    ' | Tip: HTTPS, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ/–±—Ä–∞—É–∑–µ—Ä–µ/—Å–∞–π—Ç–µ, –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–≤–∞–π—Å.';
  alert('Start error: ' + msg + '\n\n–ü—Ä–æ–≤–µ—Ä—å: HTTPS, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞/—Å–∏—Å—Ç–µ–º—ã, –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.');
}
};

btnCopyOffer.onclick = async () => {
  if (!offerOut.value) return;
  await navigator.clipboard.writeText(offerOut.value);
  noteEl.textContent = 'Call Key copied to clipboard';
};

btnAcceptAnswer.onclick = async () => {
  try{
    const key = (answerIn.value||'').trim();
    if(!key) return alert('Paste Answer Key first');
    const answer = b64uDecode(key);
    await pcCaller.setRemoteDescription(new RTCSessionDescription(answer));
    setStatus('connected (caller)', 'ok');
  } catch(e){ console.error(e); setStatus('error applying answer', 'err'); }
};

btnStopCall.onclick = () => {
  if (pcCaller) pcCaller.close();
  if (localStreamCaller) localStreamCaller.getTracks().forEach(t=>t.stop());
  pcCaller = null; localStreamCaller = null;
  offerOut.value = ''; answerIn.value='';
  btnCopyOffer.disabled = true; btnAcceptAnswer.disabled = true; btnStopCall.disabled = true;
  setStatus('idle');
};

// ---- Callee flow ----
btnAcceptOffer.onclick = async () => {
  try{
    const key = (offerIn.value||'').trim();
    if(!key) return alert('Paste Call Key first');

    setStatus('preparing (callee)‚Ä¶', 'warn');
    const offer = b64uDecode(key);

    localStreamCallee = await getMic();
    pcCallee = new RTCPeerConnection({ iceServers });
    localStreamCallee.getTracks().forEach(t => pcCallee.addTrack(t, localStreamCallee));
    attachRemoteAudio(pcCallee);

    await pcCallee.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pcCallee.createAnswer();
    await pcCallee.setLocalDescription(answer);
    await waitIceGathering(pcCallee);

    const payload = { sdp: pcCallee.localDescription.sdp, type: pcCallee.localDescription.type };
    const keyOut = b64uEncode(payload);
    answerOut.value = keyOut;
    btnCopyAnswer.disabled = false; btnStopAnswer.disabled = false;
    setStatus('answer ready ‚Äî send back to caller', 'ok');
  } catch(e){ console.error(e); setStatus('error generating answer', 'err'); }
};

btnCopyAnswer.onclick = async () => {
  if (!answerOut.value) return;
  await navigator.clipboard.writeText(answerOut.value);
  noteEl.textContent = 'Answer Key copied to clipboard';
};

btnStopAnswer.onclick = () => {
  if (pcCallee) pcCallee.close();
  if (localStreamCallee) localStreamCallee.getTracks().forEach(t=>t.stop());
  pcCallee = null; localStreamCallee = null;
  offerIn.value = ''; answerOut.value='';
  btnCopyAnswer.disabled = true; btnStopAnswer.disabled = true;
  setStatus('idle');
};

</script>
</body>
</html>
